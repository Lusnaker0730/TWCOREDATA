# 新功能說明：資料統計儀表板 & 情境預設模式

## 🎉 功能概述

成功為 Taiwan FHIR Generator 添加了兩大重要功能：

1. **📊 資料統計儀表板** - 即時查看已生成的 FHIR 資料統計
2. **🎯 情境預設模式** - 一鍵套用常見醫療情境設定

---

## 📊 功能一：資料統計儀表板

### **訪問方式**
- 網址：http://localhost:5000/dashboard
- 或點擊首頁上方的「統計儀表板」按鈕

### **主要功能**

#### 1. **即時統計資料**
顯示以下統計指標：
- 📁 **已生成檔案數**
- 👥 **病人總數**
- 🏥 **就診記錄總數**
- 🩺 **疾病診斷總數**
- 🔬 **觀察項目總數**
- 💊 **藥物處方總數**

#### 2. **可視化圖表**

**圓餅圖 - 資源類型分布**
```
展示不同 FHIR 資源的比例分布：
- 就診記錄 (Encounter)
- 疾病 (Condition)
- 觀察 (Observation)
- 藥物 (Medication)
- 處方 (MedicationRequest)
```

**長條圖 - 資源統計**
```
直觀顯示各類資源的數量：
- 病人
- 就診
- 疾病
- 觀察
- 藥物
- 處方
```

#### 3. **最近生成檔案列表**
顯示最近10個生成的檔案，包含：
- 檔案名稱
- 生成時間
- 檔案大小
- 包含的病人數量

#### 4. **自動更新**
- 每 30 秒自動刷新統計資料
- 或點擊「重新整理」按鈕手動更新

### **API 端點**

```python
GET /api/statistics
```

返回格式：
```json
{
  "total_files": 15,
  "total_patients": 45,
  "total_encounters": 90,
  "total_conditions": 90,
  "total_observations": 135,
  "total_medications": 90,
  "total_medication_requests": 90,
  "recent_generations": [
    {
      "filename": "tw_complete_patients_fixed_20241104_130500.json",
      "timestamp": "2024-11-04 13:05:00",
      "size": "256.42 KB",
      "patients": 5
    }
  ]
}
```

---

## 🎯 功能二：情境預設模式

### **訪問方式**
- 在首頁批量生成頁面的「情境預設模式」下拉選單中選擇

### **包含的醫療情境**

#### 1. **🩺 糖尿病患者**
```
疾病：糖尿病
觀察：血糖、HbA1c、血糖（飯前）、收縮壓、舒張壓
藥物：Metformin、Insulin、Glyburide
就診：2 次
建議病人數：5 人
```

#### 2. **❤️ 高血壓患者**
```
疾病：高血壓
觀察：收縮壓、舒張壓、心率、體重
藥物：Lisinopril、Amlodipine、Losartan
就診：2 次
建議病人數：5 人
```

#### 3. **🫁 氣喘患者**
```
疾病：氣喘
觀察：血氧濃度、心率、體溫
藥物：Albuterol、Fluticasone、Montelukast
就診：1 次
建議病人數：3 人
```

#### 4. **🏥 健康檢查**
```
疾病：無
觀察：收縮壓、舒張壓、體重、身高、BMI、總膽固醇、低密度脂蛋白
藥物：無
就診：1 次
建議病人數：10 人
```

#### 5. **💨 慢性阻塞性肺病 (COPD)**
```
疾病：COPD
觀察：血氧濃度、心率、體溫、收縮壓
藥物：Tiotropium、Fluticasone、Albuterol
就診：2 次
建議病人數：3 人
```

#### 6. **💔 心臟衰竭**
```
疾病：心臟衰竭
觀察：收縮壓、舒張壓、心率、體重、血氧濃度
藥物：Amlodipine、Lisinopril、Furosemide
就診：3 次
建議病人數：3 人
```

#### 7. **🤰 產前檢查**
```
疾病：懷孕
觀察：收縮壓、舒張壓、體重、身高、血糖
藥物：無
就診：4 次
建議病人數：5 人
```

#### 8. **👴 老年人綜合照護**
```
疾病：高血壓、糖尿病、COPD
觀察：收縮壓、舒張壓、血糖、HbA1c、體重、血氧濃度
藥物：Lisinopril、Metformin、Tiotropium、Albuterol
就診：3 次
建議病人數：5 人
```

#### 9. **🧠 心理健康追蹤**
```
疾病：憂鬱症、焦慮症
觀察：收縮壓、舒張壓、心率、體重
藥物：Sertraline、Escitalopram
就診：2 次
建議病人數：5 人
```

#### 10. **🏥 術後追蹤**
```
疾病：無
觀察：收縮壓、舒張壓、體溫、心率、體重
藥物：Acetaminophen、Ibuprofen
就診：2 次
建議病人數：3 人
```

#### 11. **🚑 急診就醫**
```
疾病：發燒、急性腹痛
觀察：體溫、心率、收縮壓、舒張壓、血氧濃度
藥物：Acetaminophen、Ibuprofen
就診：1 次
建議病人數：3 人
```

### **使用方式**

1. **選擇情境**
   - 在下拉選單中選擇所需的醫療情境
   - 系統會顯示確認訊息，包含建議的設定

2. **自動填入參數**
   - 病人數量
   - 疾病數量
   - 觀察記錄數量
   - 藥物數量
   - 就診記錄數量

3. **可自行調整**
   - 自動填入後，仍可手動修改任何參數
   - 選擇「自訂設定（不使用預設）」可完全自訂

### **API 端點**

```python
GET /api/scenarios
```

返回格式：
```json
{
  "scenarios": [
    {
      "id": "diabetes",
      "name": "糖尿病患者",
      "icon": "🩺",
      "description": "第二型糖尿病患者的典型醫療資料",
      "conditions": ["73211009"],
      "condition_names": ["糖尿病"],
      "observations": ["2339-0", "4548-4", "2345-7", "8480-6", "8462-4"],
      "observation_names": ["血糖", "HbA1c", "血糖（飯前）", "收縮壓", "舒張壓"],
      "medications": ["860975", "5856", "203323"],
      "medication_names": ["Metformin", "Insulin", "Glyburide"],
      "num_encounters": 2,
      "recommended_patient_count": 5
    }
  ]
}
```

---

## 🎨 介面更新

### **首頁導航**
在首頁頂部新增導航按鈕：
```
┌──────────────────────────────────────┐
│  台灣 FHIR 病人資料生成器            │
├──────────────────────────────────────┤
│ [📊 統計儀表板] [👤 自定義生成]      │
└──────────────────────────────────────┘
```

### **情境選擇區域**
在生成設定表單頂部新增情境選擇：
```
┌─────────────────────────────────────────┐
│ ✨ 情境預設模式                         │
├─────────────────────────────────────────┤
│ [下拉選單：選擇常見醫療情境...]         │
│ ℹ️ 選擇常見醫療情境，自動填入相關參數   │
└─────────────────────────────────────────┘
```

### **統計儀表板介面**
```
┌───────────────────────────────────────────┐
│         資料統計儀表板                    │
├───────────────────────────────────────────┤
│ [首頁] [自定義] [🔄 重新整理]             │
├───────────────────────────────────────────┤
│ 📁 已生成  👥 病人   🏥 就診              │
│   檔案        總數      記錄              │
│   [15]       [45]     [90]               │
├───────────────────────────────────────────┤
│ 🩺 疾病   🔬 觀察   💊 藥物               │
│   診斷      項目      處方                │
│   [90]     [135]    [90]                 │
├───────────────────────────────────────────┤
│  [圓餅圖]          [長條圖]               │
│  資源分布          資源統計               │
├───────────────────────────────────────────┤
│ 🕐 最近生成的檔案                         │
│ • tw_patients_20241104.json  (5 病人)    │
│ • tw_patients_20241103.json  (10 病人)   │
└───────────────────────────────────────────┘
```

---

## 📁 檔案結構

### **新增檔案**

```
├── config/
│   └── scenarios.json          ← 情境預設配置
├── templates/
│   └── dashboard.html          ← 統計儀表板頁面
├── app.py                      ← 更新（添加 API）
├── templates/index.html        ← 更新（添加情境選擇）
└── NEW_FEATURES.md            ← 本說明文件
```

### **scenarios.json 結構**

```json
{
  "scenarios": [
    {
      "id": "情境ID",
      "name": "情境名稱",
      "icon": "圖示",
      "description": "描述",
      "conditions": ["疾病代碼"],
      "condition_names": ["疾病名稱"],
      "observations": ["觀察代碼"],
      "observation_names": ["觀察名稱"],
      "medications": ["藥物代碼"],
      "medication_names": ["藥物名稱"],
      "num_encounters": 就診次數,
      "recommended_patient_count": 建議病人數
    }
  ]
}
```

---

## 🔧 技術實作

### **後端 (app.py)**

#### 新增路由：

1. **`/dashboard`** - 統計儀表板頁面
```python
@app.route('/dashboard')
def dashboard():
    return render_template('dashboard.html')
```

2. **`/api/scenarios`** - 獲取情境列表
```python
@app.route('/api/scenarios')
def get_scenarios():
    # 讀取 config/scenarios.json
    # 返回所有可用情境
```

3. **`/api/statistics`** - 獲取統計資料
```python
@app.route('/api/statistics')
def get_statistics():
    # 掃描 output 目錄
    # 統計所有生成的資源
    # 返回統計數據
```

### **前端**

#### **首頁 (index.html)**

新增功能：
- 情境預設下拉選單
- 導航按鈕
- JavaScript 載入情境資料
- 自動填入參數邏輯

#### **儀表板 (dashboard.html)**

使用技術：
- **Chart.js** - 繪製圖表
- **Fetch API** - 載入統計資料
- **響應式設計** - 支援各種螢幕
- **自動更新** - 每 30 秒刷新

---

## 🚀 使用範例

### **範例 1：使用情境預設快速生成糖尿病患者資料**

1. 訪問 http://localhost:5000
2. 在「情境預設模式」下拉選單中選擇「🩺 糖尿病患者」
3. 系統自動填入：
   - 病人數量：5
   - 疾病數：1
   - 觀察數：5
   - 藥物數：3
   - 就診記錄：2
4. 點擊「開始生成」
5. 等待生成完成

**結果**：
生成 5 個糖尿病患者的完整資料，每人包含：
- 基本資料
- 2 次門診/急診/住院記錄
- 糖尿病診斷
- 5 項相關檢查（血糖、HbA1c 等）
- 3 種糖尿病藥物和處方

### **範例 2：查看統計儀表板**

1. 訪問 http://localhost:5000/dashboard
2. 查看即時統計：
   - 已生成 15 個檔案
   - 包含 45 個病人
   - 共 90 筆就診記錄
   - 等等...
3. 查看圖表：
   - 圓餅圖顯示資源分布
   - 長條圖顯示數量統計
4. 查看最近檔案列表
5. 點擊「重新整理」更新資料

---

## 📊 統計資料來源

系統會自動掃描以下目錄：

1. **`output/complete_patients_fixed/`**
   - 批量生成的檔案
   - 最多讀取最近 10 個檔案

2. **`output/custom_patients/`**
   - 自定義生成的檔案
   - 最多讀取最近 5 個檔案

### **統計邏輯**

```python
# 對每個 JSON 檔案：
for patient_data in json_file:
    total_patients += 1
    total_encounters += len(encounters)
    total_conditions += len(conditions)
    total_observations += len(observations)
    total_medications += len(medications)
    total_medication_requests += len(medication_requests)
```

---

## 🎯 使用場景

### **情境 1：研究單位需要特定疾病的測試資料**
選擇「糖尿病患者」情境，快速生成標準化的糖尿病患者資料用於系統測試。

### **情境 2：醫院資訊系統開發測試**
選擇「老年人綜合照護」情境，生成包含多重慢性病的複雜病人資料，測試系統處理能力。

### **情境 3：FHIR 伺服器壓力測試**
選擇「健康檢查」情境，生成 100 個健康檢查資料，測試伺服器效能。

### **情境 4：醫療資料分析**
使用統計儀表板查看已生成的資料分布，了解測試資料的覆蓋範圍。

---

## 💡 優勢與特色

### **情境預設模式**
✅ **快速上手** - 新用戶無需了解醫療代碼
✅ **標準化** - 確保生成的資料符合真實情境
✅ **靈活調整** - 可在預設基礎上微調
✅ **覆蓋全面** - 包含 11 種常見醫療情境

### **資料統計儀表板**
✅ **即時監控** - 了解已生成的資料量
✅ **可視化** - 圖表清楚展示資料分布
✅ **追蹤歷史** - 查看最近的生成記錄
✅ **自動更新** - 保持資料最新

---

## 🔄 未來擴展

### **情境預設模式**
- [ ] 支援自訂情境
- [ ] 情境匯入/匯出
- [ ] 情境分享功能
- [ ] 更多專科情境（兒科、婦科、骨科等）

### **統計儀表板**
- [ ] 更多圖表類型（折線圖、雷達圖）
- [ ] 資料匯出功能（PDF、Excel）
- [ ] 資料比較功能
- [ ] 自訂統計週期
- [ ] 資料清理工具

---

## ✅ 完成項目

- [x] 創建情境預設配置檔案 (scenarios.json)
- [x] 實作情境 API 端點 (/api/scenarios)
- [x] 實作統計 API 端點 (/api/statistics)
- [x] 創建統計儀表板頁面 (dashboard.html)
- [x] 更新首頁支援情境選擇
- [x] 添加導航按鈕
- [x] 實作圖表可視化 (Chart.js)
- [x] 實作自動更新機制
- [x] Docker 容器部署
- [x] 功能測試通過

---

## 🎓 總結

這兩個新功能大幅提升了 Taiwan FHIR Generator 的易用性和實用性：

1. **情境預設模式**讓新用戶可以快速上手，無需深入了解 FHIR 和醫療代碼
2. **統計儀表板**提供了直觀的資料監控，幫助用戶了解已生成的資料規模和分布

這些功能使 Taiwan FHIR Generator 成為一個更完整、更專業的 FHIR 測試資料生成工具！🎉

---

## 📞 訪問連結

- **首頁（批量生成）**: http://localhost:5000
- **統計儀表板**: http://localhost:5000/dashboard
- **自定義生成**: http://localhost:5000/custom
- **情境 API**: http://localhost:5000/api/scenarios
- **統計 API**: http://localhost:5000/api/statistics


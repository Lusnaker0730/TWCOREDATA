name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # å®‰è£æ¸¬è©¦ä¾è³´ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        # pip install pytest pytest-cov flake8

    - name: Lint with flake8
      run: |
        # å¦‚æœæœ‰å®‰è£flake8ï¼Œå–æ¶ˆè¨»è§£ä»¥ä¸‹è¡Œ
        # flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        echo "Linting skipped - install flake8 to enable"

    - name: Test configuration files
      run: |
        python -c "
        import json
        from pathlib import Path
        
        # æ¸¬è©¦é…ç½®æª”æ¡ˆæ˜¯å¦æœ‰æ•ˆ
        config_files = [
            'config/conditions.json',
            'config/observations.json', 
            'config/medications.json'
        ]
        
        for file_path in config_files:
            if Path(file_path).exists():
                with open(file_path, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    print(f'âœ… {file_path}: {len(data)} items loaded')
            else:
                print(f'âŒ {file_path}: File not found')
                exit(1)
        "

    - name: Test imports
      run: |
        python -c "
        try:
            from generate_TW_patients import TWFHIRGeneratorFixed
            from config_loader import ConfigLoader
            import app
            print('âœ… All imports successful')
        except ImportError as e:
            print(f'âŒ Import error: {e}')
            exit(1)
        "

    - name: Test basic functionality
      run: |
        python -c "
        from generate_TW_patients import TWFHIRGeneratorFixed
        
        # æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
        generator = TWFHIRGeneratorFixed()
        print(f'âœ… Generator initialized')
        print(f'   Conditions: {len(generator.conditions)}')
        print(f'   Observations: {len(generator.observations)}')
        print(f'   Medications: {len(generator.medications)}')
        
        # æ¸¬è©¦ç”Ÿæˆå–®ä¸€ç—…äºº
        patient = generator.generate_patient()
        print(f'âœ… Patient generated: {patient[\"name\"][0][\"text\"]}')
        "

  docker:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -t taiwan-fhir-generator:latest .

    - name: Test Docker image
      run: |
        # å•Ÿå‹•å®¹å™¨ä¸¦æ¸¬è©¦
        docker run -d --name test-container -p 5000:5000 taiwan-fhir-generator:latest
        sleep 30
        
        # æ¸¬è©¦å¥åº·æª¢æŸ¥
        if curl -f http://localhost:5000/; then
          echo "âœ… Docker container is healthy"
        else
          echo "âŒ Docker container health check failed"
          docker logs test-container
          exit 1
        fi
        
        # æ¸…ç†
        docker stop test-container
        docker rm test-container

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Run security scan
      run: |
        # æª¢æŸ¥æ•æ„Ÿè³‡è¨Š
        echo "ğŸ” Scanning for sensitive information..."
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ç¡¬ç·¨ç¢¼çš„å¯†ç¢¼æˆ–APIé‡‘é‘°
        if grep -r -i "password\|api_key\|secret\|token" --exclude-dir=.git --exclude="*.md" .; then
          echo "âš ï¸ Found potential sensitive information"
        else
          echo "âœ… No obvious sensitive information found"
        fi

  release:
    runs-on: ubuntu-latest
    needs: [test, docker]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Create Release
      if: contains(github.event.head_commit.message, '[release]')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          è‡ªå‹•ç™¼å¸ƒç‰ˆæœ¬ / Automated release
          
          è®Šæ›´å…§å®¹ / Changes:
          ${{ github.event.head_commit.message }}
        draft: false
        prerelease: false

# Encounter (å°±è¨ºè¨˜éŒ„) åŠŸèƒ½èªªæ˜

## ğŸ‰ åŠŸèƒ½æ¦‚è¿°

æˆåŠŸç‚º Taiwan FHIR Generator æ·»åŠ äº† **Encounter (å°±è¨ºè¨˜éŒ„)** æ”¯æ´ï¼

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. **å°±è¨ºè¨˜éŒ„é¡å‹**

ç³»çµ±æ”¯æ´ä¸‰ç¨®å°±è¨ºé¡å‹ï¼Œä¸¦æœƒè‡ªå‹•æ ¹æ“šé¡å‹ç”Ÿæˆåˆç†çš„æ™‚é•·ï¼š

- **é–€è¨º (Outpatient)** 
  - FHIR Class Code: `AMB`
  - å°±è¨ºæ™‚é•·: 15-60 åˆ†é˜
  - æ©Ÿç‡: 60% (æœ€å¸¸è¦‹)

- **æ€¥è¨º (Emergency)**
  - FHIR Class Code: `EMER`
  - å°±è¨ºæ™‚é•·: 1-4 å°æ™‚
  - æ©Ÿç‡: 20%

- **ä½é™¢ (Inpatient)**
  - FHIR Class Code: `IMP`
  - å°±è¨ºæ™‚é•·: 1-7 å¤©
  - æ©Ÿç‡: 20%

### 2. **Encounter è³‡æºçµæ§‹**

ç”Ÿæˆçš„ Encounter è³‡æºåŒ…å«ï¼š

```json
{
  "resourceType": "Encounter",
  "id": "å”¯ä¸€è­˜åˆ¥ç¢¼",
  "status": "finished",
  "class": {
    "system": "http://terminology.hl7.org/CodeSystem/v3-ActCode",
    "code": "AMB/EMER/IMP",
    "display": "Ambulatory/Emergency/Inpatient"
  },
  "type": [
    {
      "coding": [
        {
          "system": "http://snomed.info/sct",
          "code": "SNOMEDä»£ç¢¼",
          "display": "é–€è¨º/æ€¥è¨º/ä½é™¢"
        }
      ]
    }
  ],
  "subject": {
    "reference": "Patient/ç—…äººID",
    "display": "ç—…äººå§“å"
  },
  "period": {
    "start": "2024-XX-XXTXX:XX:XX+08:00",
    "end": "2024-XX-XXTXX:XX:XX+08:00"
  },
  "reasonCode": [
    {
      "text": "å°±è¨ºåŸå› èªªæ˜"
    }
  ]
}
```

### 3. **Web UI æ›´æ–°**

#### **æ‰¹é‡ç”Ÿæˆé é¢ (index.html)**

æ–°å¢ã€Œæ¯äººå°±è¨ºè¨˜éŒ„æ•¸ã€è¼¸å…¥æ¬„ä½ï¼š
- é è¨­å€¼: 1
- ç¯„åœ: 0-10
- å¯è¨­ç‚º 0 è·³éå°±è¨ºè¨˜éŒ„ç”Ÿæˆ

![å°±è¨ºè¨˜éŒ„è¼¸å…¥æ¬„ä½ä½ç½®]
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰¹é‡ç”Ÿæˆè¨­å®š                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç—…äººæ•¸é‡: [2]  ç–¾ç—…æ•¸: [2]           â”‚
â”‚ è§€å¯Ÿè¨˜éŒ„æ•¸: [3]                      â”‚
â”‚ è—¥ç‰©æ•¸é‡: [2]  å°±è¨ºè¨˜éŒ„æ•¸: [1] â† æ–°å¢ â”‚
â”‚ ä¸Šå‚³é¸é …: [ä¸‹æ‹‰é¸å–®]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **çµæœçµ±è¨ˆé¡¯ç¤º**

ç”Ÿæˆçµæœæœƒé¡¯ç¤ºï¼š
- âœ… ç—…äººæ•¸é‡
- âœ… **å°±è¨ºè¨˜éŒ„æ•¸é‡** (æ–°å¢)
- âœ… ç–¾ç—…æ•¸é‡
- âœ… è§€å¯Ÿæ•¸é‡
- âœ… è—¥ç‰©æ•¸é‡
- âœ… è™•æ–¹æ•¸é‡

ä¸Šå‚³çµæœä¹Ÿæœƒé¡¯ç¤ºï¼š
- âœ… æˆåŠŸä¸Šå‚³ç—…äººæ•¸
- âœ… **æˆåŠŸä¸Šå‚³å°±è¨ºè¨˜éŒ„æ•¸** (æ–°å¢)
- âœ… æˆåŠŸä¸Šå‚³ç–¾ç—…æ•¸
- âœ… æˆåŠŸä¸Šå‚³è§€å¯Ÿæ•¸
- âœ… æˆåŠŸä¸Šå‚³è—¥ç‰©æ•¸
- âœ… æˆåŠŸä¸Šå‚³è™•æ–¹æ•¸
- âš ï¸ éŒ¯èª¤æ•¸é‡

## ğŸ”§ æŠ€è¡“å¯¦ä½œç´°ç¯€

### å¾Œç«¯ä¿®æ”¹

#### 1. **generate_TW_patients.py**

æ–°å¢æ–¹æ³•ï¼š
```python
def generate_encounter(self, patient_id, patient_name, encounter_type="outpatient"):
    """ç”Ÿæˆå°±è¨ºè¨˜éŒ„ (Encounter) è³‡æº"""
    # ç”Ÿæˆå®Œæ•´çš„ FHIR Encounter è³‡æº
    # åŒ…å«æ™‚é–“ã€é¡å‹ã€ç—…äººå¼•ç”¨ç­‰
```

æ›´æ–°æ–¹æ³•ï¼š
```python
def generate_complete_patient_data(self, num_conditions=2, num_observations=3, 
                                   num_medications=2, num_encounters=1):
    # æ–°å¢ num_encounters åƒæ•¸
    # è¿”å›å€¼åŒ…å« encounters åˆ—è¡¨
```

```python
def upload_patient_data_to_server(self, patient_data, server_url):
    # æ–°å¢ Encounter ä¸Šå‚³é‚è¼¯
    # æ›´æ–° Patient ID å¼•ç”¨
```

#### 2. **app.py**

æ›´æ–° Flask è·¯ç”±ï¼š
```python
@app.route('/generate', methods=['POST'])
def generate_data():
    num_encounters = int(request.form.get('num_encounters', 1))  # æ–°å¢
    # å‚³éçµ¦ç”Ÿæˆå™¨
```

æ›´æ–°èƒŒæ™¯ä»»å‹™ï¼š
```python
def generate_data_background(num_patients, num_conditions, num_observations, 
                            num_medications, num_encounters, server_choice, custom_server):
    # æ–°å¢ num_encounters åƒæ•¸
    # æ›´æ–°çµ±è¨ˆä¿¡æ¯
```

### å‰ç«¯ä¿®æ”¹

#### 1. **templates/index.html**

æ–°å¢è¡¨å–®æ¬„ä½ï¼š
```html
<div class="form-group">
    <label for="num_encounters">æ¯äººå°±è¨ºè¨˜éŒ„æ•¸ (å¯è¨­ç‚º0)</label>
    <input type="number" id="num_encounters" name="num_encounters" 
           value="1" min="0" max="10" required>
</div>
```

æ›´æ–° JavaScript çµ±è¨ˆé¡¯ç¤ºï¼š
```javascript
html += `<div class="stat-item">
    <div class="number">${results.num_encounters || 0}</div>
    <div class="label">å°±è¨ºè¨˜éŒ„</div>
</div>`;

html += `<p><strong>æˆåŠŸä¸Šå‚³å°±è¨ºè¨˜éŒ„:</strong> 
         ${results.upload.total_encounters || 0}</p>`;
```

## ğŸ“Š ä½¿ç”¨ç¯„ä¾‹

### ç¯„ä¾‹ 1: ç”ŸæˆåŒ…å«å°±è¨ºè¨˜éŒ„çš„ç—…äººè³‡æ–™

```python
from generate_TW_patients import TWFHIRGeneratorFixed

generator = TWFHIRGeneratorFixed()

# ç”Ÿæˆ1å€‹ç—…äººï¼ŒåŒ…å«2å€‹ç–¾ç—…ã€3å€‹è§€å¯Ÿã€2å€‹è—¥ç‰©ã€1å€‹å°±è¨ºè¨˜éŒ„
patient_data = generator.generate_complete_patient_data(
    num_conditions=2,
    num_observations=3,
    num_medications=2,
    num_encounters=1  # æ–°å¢åƒæ•¸
)

# patient_data ç¾åœ¨åŒ…å«:
# - patient: ç—…äººåŸºæœ¬è³‡æ–™
# - encounters: å°±è¨ºè¨˜éŒ„åˆ—è¡¨ â† æ–°å¢
# - conditions: ç–¾ç—…åˆ—è¡¨
# - observations: è§€å¯Ÿé …ç›®åˆ—è¡¨
# - medications: è—¥ç‰©åˆ—è¡¨
# - medication_requests: è™•æ–¹åˆ—è¡¨
```

### ç¯„ä¾‹ 2: Web UI ä½¿ç”¨

1. æ‰“é–‹ç€è¦½å™¨è¨ªå•: http://localhost:5000
2. åœ¨ã€Œæ‰¹é‡ç”Ÿæˆè¨­å®šã€ä¸­ï¼š
   - ç—…äººæ•¸é‡: 5
   - æ¯äººç–¾ç—…æ•¸: 2
   - æ¯äººè§€å¯Ÿè¨˜éŒ„æ•¸: 3
   - æ¯äººè—¥ç‰©æ•¸é‡: 2
   - **æ¯äººå°±è¨ºè¨˜éŒ„æ•¸: 2** â† æ–°è¨­å®š
3. é¸æ“‡ä¸Šå‚³é¸é …
4. é»æ“Šã€Œé–‹å§‹ç”Ÿæˆã€

ç³»çµ±æœƒç”Ÿæˆï¼š
- 5 å€‹ç—…äºº
- 10 å€‹å°±è¨ºè¨˜éŒ„ (5 x 2) â† æ–°å¢
- 10 å€‹ç–¾ç—… (5 x 2)
- 15 å€‹è§€å¯Ÿ (5 x 3)
- 10 å€‹è—¥ç‰© (5 x 2)
- 10 å€‹è™•æ–¹ (5 x 2)

### ç¯„ä¾‹ 3: ä¸ç”Ÿæˆå°±è¨ºè¨˜éŒ„

å¦‚æœä¸éœ€è¦å°±è¨ºè¨˜éŒ„ï¼Œåªéœ€å°‡ã€Œæ¯äººå°±è¨ºè¨˜éŒ„æ•¸ã€è¨­ç‚º **0**ï¼š

```
æ¯äººå°±è¨ºè¨˜éŒ„æ•¸: 0
```

ç³»çµ±æœƒè·³é Encounter ç”Ÿæˆï¼Œå…¶ä»–è³‡æºæ­£å¸¸ç”Ÿæˆã€‚

## ğŸ“ ç”Ÿæˆçš„è³‡æ–™çµæ§‹

### JSON æª”æ¡ˆçµæ§‹

```json
[
  {
    "patient": { ... },
    "encounters": [
      {
        "resourceType": "Encounter",
        "id": "xxx-xxx-xxx",
        "status": "finished",
        "class": { ... },
        "subject": { "reference": "Patient/xxx" },
        "period": { ... }
      }
    ],
    "conditions": [ ... ],
    "observations": [ ... ],
    "medications": [ ... ],
    "medication_requests": [ ... ]
  }
]
```

## ğŸ”— è³‡æºé—œè¯

Encounter èˆ‡å…¶ä»–è³‡æºçš„é—œè¯ï¼š

```
Patient (ç—…äºº)
    â†“
    â””â”€ Encounter (å°±è¨ºè¨˜éŒ„)
           â†“ (å¯åœ¨æœªä¾†ç‰ˆæœ¬ä¸­é—œè¯)
           â”œâ”€ Condition (åœ¨æ­¤æ¬¡å°±è¨ºä¸­è¨ºæ–·çš„ç–¾ç—…)
           â”œâ”€ Observation (åœ¨æ­¤æ¬¡å°±è¨ºä¸­çš„æª¢æŸ¥)
           â””â”€ MedicationRequest (åœ¨æ­¤æ¬¡å°±è¨ºä¸­é–‹ç«‹çš„è™•æ–¹)
```

**ç›®å‰ç‰ˆæœ¬**: Encounter é—œè¯åˆ° Patient
**æœªä¾†å¯æ“´å±•**: Conditionã€Observationã€MedicationRequest å¯é—œè¯åˆ°ç‰¹å®š Encounter

## ğŸ¯ è³‡æ–™ç‰¹é»

### 1. **çœŸå¯¦æ€§**
- å°±è¨ºæ™‚é–“åˆ†å¸ƒåœ¨éå»6å€‹æœˆ
- é–€è¨ºæ™‚é•·: 15-60åˆ†é˜
- æ€¥è¨ºæ™‚é•·: 1-4å°æ™‚
- ä½é™¢æ™‚é•·: 1-7å¤©

### 2. **å°ç£æ™‚å€**
- æ‰€æœ‰æ™‚é–“ä½¿ç”¨ `+08:00` (å°åŒ—æ™‚å€)
- æ ¼å¼: `2024-11-04T14:30:00+08:00`

### 3. **FHIR è¦ç¯„**
- å®Œå…¨ç¬¦åˆ FHIR R4 æ¨™æº–
- ä½¿ç”¨æ¨™æº–åŒ–ä»£ç¢¼ç³»çµ±
- åŒ…å« Narrative æ•˜è¿°æ€§æ–‡å­—

## ğŸš€ æ¸¬è©¦æ­¥é©Ÿ

### 1. å•Ÿå‹•æ‡‰ç”¨

```bash
docker compose up -d
```

### 2. è¨ªå• Web UI

```
http://localhost:5000
```

### 3. æ¸¬è©¦ç”Ÿæˆ

è¨­å®šåƒæ•¸ä¸¦ç”Ÿæˆï¼ŒæŸ¥çœ‹çµæœä¸­æ˜¯å¦åŒ…å«å°±è¨ºè¨˜éŒ„çµ±è¨ˆ

### 4. æŸ¥çœ‹ç”Ÿæˆçš„æª”æ¡ˆ

```bash
cat output/complete_patients_fixed/tw_complete_patients_fixed_*.json
```

æª¢æŸ¥æ˜¯å¦åŒ…å« `encounters` é™£åˆ—

### 5. æ¸¬è©¦ä¸Šå‚³ (å¯é¸)

é¸æ“‡ FHIR ä¼ºæœå™¨ä¸¦ä¸Šå‚³ï¼ŒæŸ¥çœ‹ä¸Šå‚³çµæœä¸­çš„å°±è¨ºè¨˜éŒ„çµ±è¨ˆ

## ğŸ“ˆ çµ±è¨ˆè³‡è¨Š

ç”Ÿæˆ2å€‹ç—…äººï¼Œæ¯äºº1å€‹å°±è¨ºè¨˜éŒ„çš„ç¯„ä¾‹è¼¸å‡ºï¼š

```
âœ… è³‡æ–™ç”ŸæˆæˆåŠŸï¼

çµ±è¨ˆè³‡è¨Š:
- ç—…äºº: 2
- å°±è¨ºè¨˜éŒ„: 2 â† æ–°å¢
- ç–¾ç—…: 4
- è§€å¯Ÿ: 6
- è—¥ç‰©: 4
- è™•æ–¹: 4

æª”æ¡ˆä½ç½®: output/complete_patients_fixed/tw_complete_patients_fixed_20241104_205530.json
```

## ğŸ¨ æœªä¾†å¯æ“´å±•åŠŸèƒ½

1. **Encounter èˆ‡å…¶ä»–è³‡æºçš„é—œè¯**
   - å°‡ Condition é—œè¯åˆ°ç‰¹å®š Encounter
   - å°‡ Observation é—œè¯åˆ°ç‰¹å®š Encounter
   - å°‡ MedicationRequest é—œè¯åˆ°ç‰¹å®š Encounter

2. **æ›´å¤š Encounter é¡å‹**
   - é è·é†«ç™‚ (Telemedicine)
   - å±…å®¶ç…§è­· (Home Health)
   - å¥åº·æª¢æŸ¥ (Health Check)

3. **Encounter è©³ç´°è³‡è¨Š**
   - å°±è¨ºç§‘åˆ¥ (Department)
   - ä¸»è¨ºé†«å¸« (Practitioner)
   - è¨ºæ–·æ‘˜è¦ (Diagnosis)
   - è²»ç”¨è³‡è¨Š (Account/ChargeItem)

4. **æ™‚åºæ€§å°±é†«æ­·ç¨‹**
   - ç”Ÿæˆå®Œæ•´çš„å°±é†«æ™‚é–“ç·š
   - åˆè¨ºâ†’è¤‡è¨ºâ†’ä½é™¢â†’å‡ºé™¢
   - ç—…æƒ…è¿½è¹¤èˆ‡è®ŠåŒ–

## âœ… å®Œæˆé …ç›®

- [x] å¯¦ä½œ Encounter ç”Ÿæˆæ–¹æ³•
- [x] æ›´æ–°æ‰¹é‡ç”Ÿæˆé‚è¼¯
- [x] æ›´æ–°è‡ªå®šç¾©ç”Ÿæˆé‚è¼¯
- [x] æ›´æ–°ä¸Šå‚³é‚è¼¯
- [x] æ›´æ–° Web UI (index.html)
- [x] æ›´æ–°çµæœçµ±è¨ˆé¡¯ç¤º
- [x] æ›´æ–°ä¸Šå‚³çµæœé¡¯ç¤º
- [x] Docker å®¹å™¨é‡å»ºèˆ‡æ¸¬è©¦
- [x] æ–‡ä»¶æ’°å¯«

## ğŸ“ ç¸½çµ

Encounter (å°±è¨ºè¨˜éŒ„) åŠŸèƒ½çš„æˆåŠŸå¯¦ä½œç‚º Taiwan FHIR Generator å¢æ·»äº†é‡è¦çš„é†«ç™‚æƒ…å¢ƒè³‡è¨Šã€‚é€™å€‹åŠŸèƒ½ï¼š

1. **å®Œæ•´æ€§**: ç¬¦åˆ FHIR R4 æ¨™æº–
2. **å¯¦ç”¨æ€§**: æ”¯æ´é–€è¨ºã€æ€¥è¨ºã€ä½é™¢ä¸‰ç¨®å¸¸è¦‹å ´æ™¯
3. **éˆæ´»æ€§**: å¯è¨­å®šç”Ÿæˆæ•¸é‡ï¼ŒåŒ…æ‹¬0 (ä¸ç”Ÿæˆ)
4. **æ˜“ç”¨æ€§**: Web UI æ•´åˆå®Œå–„ï¼Œæ“ä½œç°¡å–®
5. **å¯æ“´å±•æ€§**: ç‚ºæœªä¾†åŠŸèƒ½é ç•™æ“´å±•ç©ºé–“

ç¾åœ¨æ‚¨å¯ä»¥ç”ŸæˆåŒ…å«å®Œæ•´å°±é†«æƒ…å¢ƒçš„ FHIR æ¸¬è©¦è³‡æ–™äº†ï¼ ğŸ‰

